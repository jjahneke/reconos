#include "ap_utils.h"

#include "common/xf_common.hpp"
#include "core/xf_math.h"
#include "features/xf_fast.hpp"
#include "imgproc/xf_gaussian_filter.hpp"
#include "hls_math.h"

typedef struct {
	ap_int<5> p1x, p1y, p2x, p2y;
	uint8_t pos; // What bit of the descriptor is this?
} desc_bit_t;

/* This is for TUM1, fixed point 16 bit, 10 integer, 6 fractional */
const ap_int<11> undistortLookupX[14][19] = {
{ -576, -493, -444, -416, -398, -385, -373, -361, -350, -339, -330, -326, -336, -370, -446, -580, -786, -1083, -1406},
{ -434, -394, -375, -364, -354, -345, -334, -324, -314, -304, -293, -282, -274, -276, -304, -375, -508, -717, -935},
{ -352, -337, -329, -321, -310, -298, -286, -276, -268, -263, -257, -250, -240, -230, -231, -257, -332, -472, -628},
{ -296, -290, -283, -271, -255, -239, -224, -214, -209, -209, -210, -210, -207, -198, -189, -192, -225, -310, -418},
{ -247, -242, -231, -214, -194, -173, -157, -147, -144, -148, -156, -164, -168, -166, -157, -151, -159, -205, -275},
{ -197, -190, -176, -156, -133, -112, -95, -86, -85, -92, -103, -116, -126, -129, -125, -117, -115, -135, -177},
{ -144, -137, -123, -103, -82, -62, -47, -39, -40, -47, -60, -74, -85, -92, -91, -85, -79, -85, -107},
{ -91, -85, -75, -60, -44, -29, -18, -12, -13, -19, -29, -40, -50, -56, -56, -51, -44, -43, -53},
{ -38, -36, -32, -25, -17, -10, -4, -1, -2, -5, -10, -15, -19, -21, -20, -16, -9, -5, -6},
{ 17, 13, 9, 6, 4, 2, 1, 0, 0, 2, 3, 6, 9, 13, 17, 21, 27, 33, 38},
{ 73, 63, 51, 39, 26, 15, 8, 4, 5, 10, 19, 29, 39, 48, 55, 60, 65, 73, 84},
{ 132, 118, 100, 80, 59, 41, 28, 21, 22, 31, 44, 60, 75, 88, 97, 102, 106, 117, 135},
{ 194, 179, 158, 133, 108, 85, 68, 59, 60, 69, 85, 103, 121, 134, 142, 145, 149, 167, 198},
{ 243, 228, 208, 182, 155, 131, 112, 103, 103, 112, 127, 145, 161, 172, 178, 179, 186, 213, 257}};

/* This is for TUM1, fixed point 16 bit, 10 integer, 6 fractional */
const ap_int<11> undistortLookupY[14][19] = {
{ -559, -425, -332, -259, -199, -145, -96, -51, -10, 27, 62, 97, 138, 198, 298, 467, 740, 1161, 1639},
{ -481, -382, -308, -245, -188, -135, -85, -40, 1, 38, 72, 103, 132, 168, 226, 335, 534, 862, 1226},
{ -444, -365, -298, -236, -178, -124, -75, -31, 9, 46, 81, 113, 141, 167, 200, 264, 398, 650, 945},
{ -430, -358, -291, -225, -164, -109, -63, -23, 13, 49, 84, 119, 150, 176, 199, 235, 320, 505, 742},
{ -425, -352, -279, -208, -145, -92, -50, -16, 14, 45, 79, 116, 153, 184, 207, 230, 281, 412, 600},
{ -422, -343, -263, -187, -123, -72, -36, -10, 12, 36, 68, 107, 149, 187, 215, 236, 268, 359, 505},
{ -418, -332, -246, -166, -100, -53, -24, -6, 8, 26, 54, 94, 140, 185, 221, 244, 267, 331, 448},
{ -414, -322, -230, -147, -82, -37, -13, -3, 4, 16, 42, 81, 131, 182, 224, 251, 271, 320, 416},
{ -412, -316, -221, -135, -70, -27, -7, -1, 1, 10, 33, 73, 125, 180, 227, 257, 277, 319, 403},
{ -414, -317, -219, -133, -67, -25, -5, 0, 0, 8, 31, 72, 125, 181, 230, 262, 283, 323, 403},
{ -421, -324, -227, -141, -74, -30, -8, -1, 2, 13, 37, 78, 131, 188, 235, 267, 288, 331, 415},
{ -431, -337, -243, -158, -90, -43, -16, -3, 7, 22, 50, 92, 144, 197, 242, 271, 294, 345, 441},
{ -443, -354, -264, -181, -113, -62, -28, -6, 12, 34, 66, 109, 159, 208, 248, 274, 301, 368, 485},
{ -453, -368, -282, -202, -132, -78, -38, -9, 16, 44, 80, 123, 171, 216, 251, 276, 309, 395, 533}};

/* Default OS2 pattern */
const desc_bit_t pattern[256] = {
{8, -3, 9, 5, 0}, {4, 2, 7, -12, 1}, {-11, 9, -8, 2, 2}, {7, -12, 12, -13, 3}, {2, -13, 2, 12, 4}, {1, -7, 1, 6, 5}, {-2, -10, -2, -4, 6}, {-13, -13, -11, -8, 7}, {-13, -3, -12, -9, 8}, 
{10, 4, 11, 9, 9}, {-13, -8, -8, -9, 10}, {-11, 7, -9, 12, 11}, {7, 7, 12, 6, 12}, {-4, -5, -3, 0, 13}, {-13, 2, -12, -3, 14}, {-9, 0, -7, 5, 15}, {12, -6, 12, -1, 16}, 
{-3, 6, -2, 12, 17}, {-6, -13, -4, -8, 18}, {11, -13, 12, -8, 19}, {4, 7, 5, 1, 20}, {5, -3, 10, -3, 21}, {3, -7, 6, 12, 22}, {-8, -7, -6, -2, 23}, {-2, 11, -1, -10, 24}, 
{-13, 12, -8, 10, 25}, {-7, 3, -5, -3, 26}, {-4, 2, -3, 7, 27}, {-10, -12, -6, 11, 28}, {5, -12, 6, -7, 29}, {5, -6, 7, -1, 30}, {1, 0, 4, -5, 31}, {9, 11, 11, -13, 32}, 
{4, 7, 4, 12, 33}, {2, -1, 4, 4, 34}, {-4, -12, -2, 7, 35}, {-8, -5, -7, -10, 36}, {4, 11, 9, 12, 37}, {0, -8, 1, -13, 38}, {-13, -2, -8, 2, 39}, {-3, -2, -2, 3, 40}, 
{-6, 9, -4, -9, 41}, {8, 12, 10, 7, 42}, {0, 9, 1, 3, 43}, {7, -5, 11, -10, 44}, {-13, -6, -11, 0, 45}, {10, 7, 12, 1, 46}, {-6, -3, -6, 12, 47}, {10, -9, 12, -4, 48}, 
{-13, 8, -8, -12, 49}, {-13, 0, -8, -4, 50}, {3, 3, 7, 8, 51}, {5, 7, 10, -7, 52}, {-1, 7, 1, -12, 53}, {3, -10, 5, 6, 54}, {2, -4, 3, -10, 55}, {-13, 0, -13, 5, 56}, 
{-13, -7, -12, 12, 57}, {-13, 3, -11, 8, 58}, {-7, 12, -4, 7, 59}, {6, -10, 12, 8, 60}, {-9, -1, -7, -6, 61}, {-2, -5, 0, 12, 62}, {-12, 5, -7, 5, 63}, {3, -10, 8, -13, 64}, 
{-7, -7, -4, 5, 65}, {-3, -2, -1, -7, 66}, {2, 9, 5, -11, 67}, {-11, -13, -5, -13, 68}, {-1, 6, 0, -1, 69}, {5, -3, 5, 2, 70}, {-4, -13, -4, 12, 71}, {-9, -6, -9, 6, 72}, 
{-12, -10, -8, -4, 73}, {10, 2, 12, -3, 74}, {7, 12, 12, 12, 75}, {-7, -13, -6, 5, 76}, {-4, 9, -3, 4, 77}, {7, -1, 12, 2, 78}, {-7, 6, -5, 1, 79}, {-13, 11, -12, 5, 80}, 
{-3, 7, -2, -6, 81}, {7, -8, 12, -7, 82}, {-13, -7, -11, -12, 83}, {1, -3, 12, 12, 84}, {2, -6, 3, 0, 85}, {-4, 3, -2, -13, 86}, {-1, -13, 1, 9, 87}, {7, 1, 8, -6, 88}, 
{1, -1, 3, 12, 89}, {9, 1, 12, 6, 90}, {-1, -9, -1, 3, 91}, {-13, -13, -10, 5, 92}, {7, 7, 10, 12, 93}, {12, -5, 12, 9, 94}, {6, 3, 7, 11, 95}, {5, -13, 6, 10, 96}, 
{2, -12, 2, 3, 97}, {3, 8, 4, -6, 98}, {2, 6, 12, -13, 99}, {9, -12, 10, 3, 100}, {-8, 4, -7, 9, 101}, {-11, 12, -4, -6, 102}, {1, 12, 2, -8, 103}, {6, -9, 7, -4, 104}, 
{2, 3, 3, -2, 105}, {6, 3, 11, 0, 106}, {3, -3, 8, -8, 107}, {7, 8, 9, 3, 108}, {-11, -5, -6, -4, 109}, {-10, 11, -5, 10, 110}, {-5, -8, -3, 12, 111}, {-10, 5, -9, 0, 112}, 
{8, -1, 12, -6, 113}, {4, -6, 6, -11, 114}, {-10, 12, -8, 7, 115}, {4, -2, 6, 7, 116}, {-2, 0, -2, 12, 117}, {-5, -8, -5, 2, 118}, {7, -6, 10, 12, 119}, {-9, -13, -8, -8, 120}, 
{-5, -13, -5, -2, 121}, {8, -8, 9, -13, 122}, {-9, -11, -9, 0, 123}, {1, -8, 1, -2, 124}, {7, -4, 9, 1, 125}, {-2, 1, -1, -4, 126}, {11, -6, 12, -11, 127}, {-12, -9, -6, 4, 128}, 
{3, 7, 7, 12, 129}, {5, 5, 10, 8, 130}, {0, -4, 2, 8, 131}, {-9, 12, -5, -13, 132}, {0, 7, 2, 12, 133}, {-1, 2, 1, 7, 134}, {5, 11, 7, -9, 135}, {3, 5, 6, -8, 136}, 
{-13, -4, -8, 9, 137}, {-5, 9, -3, -3, 138}, {-4, -7, -3, -12, 139}, {6, 5, 8, 0, 140}, {-7, 6, -6, 12, 141}, {-13, 6, -5, -2, 142}, {1, -10, 3, 10, 143}, {4, 1, 8, -4, 144}, 
{-2, -2, 2, -13, 145}, {2, -12, 12, 12, 146}, {-2, -13, 0, -6, 147}, {4, 1, 9, 3, 148}, {-6, -10, -3, -5, 149}, {-3, -13, -1, 1, 150}, {7, 5, 12, -11, 151}, {4, -2, 5, -7, 152}, 
{-13, 9, -9, -5, 153}, {7, 1, 8, 6, 154}, {7, -8, 7, 6, 155}, {-7, -4, -7, 1, 156}, {-8, 11, -7, -8, 157}, {-13, 6, -12, -8, 158}, {2, 4, 3, 9, 159}, {10, -5, 12, 3, 160}, 
{-6, -5, -6, 7, 161}, {8, -3, 9, -8, 162}, {2, -12, 2, 8, 163}, {-11, -2, -10, 3, 164}, {-12, -13, -7, -9, 165}, {-11, 0, -10, -5, 166}, {5, -3, 11, 8, 167}, {-2, -13, -1, 12, 168}, 
{-1, -8, 0, 9, 169}, {-13, -11, -12, -5, 170}, {-10, -2, -10, 11, 171}, {-3, 9, -2, -13, 172}, {2, -3, 3, 2, 173}, {-9, -13, -4, 0, 174}, {-4, 6, -3, -10, 175}, {-4, 12, -2, -7, 176}, 
{-6, -11, -4, 9, 177}, {6, -3, 6, 11, 178}, {-13, 11, -5, 5, 179}, {11, 11, 12, 6, 180}, {7, -5, 12, -2, 181}, {-1, 12, 0, 7, 182}, {-4, -8, -3, -2, 183}, {-7, 1, -6, 7, 184}, 
{-13, -12, -8, -13, 185}, {-7, -2, -6, -8, 186}, {-8, 5, -6, -9, 187}, {-5, -1, -4, 5, 188}, {-13, 7, -8, 10, 189}, {1, 5, 5, -13, 190}, {1, 0, 10, -13, 191}, {9, 12, 10, -1, 192}, 
{5, -8, 10, -9, 193}, {-1, 11, 1, -13, 194}, {-9, -3, -6, 2, 195}, {-1, -10, 1, 12, 196}, {-13, 1, -8, -10, 197}, {8, -11, 10, -6, 198}, {2, -13, 3, -6, 199}, {7, -13, 12, -9, 200}, 
{-10, -10, -5, -7, 201}, {-10, -8, -8, -13, 202}, {4, -6, 8, 5, 203}, {3, 12, 8, -13, 204}, {-4, 2, -3, -3, 205}, {5, -13, 10, -12, 206}, {4, -13, 5, -1, 207}, {-9, 9, -4, 3, 208}, 
{0, 3, 3, -9, 209}, {-12, 1, -6, 1, 210}, {3, 2, 4, -8, 211}, {-10, -10, -10, 9, 212}, {8, -13, 12, 12, 213}, {-8, -12, -6, -5, 214}, {2, 2, 3, 7, 215}, {10, 6, 11, -8, 216}, 
{6, 8, 8, -12, 217}, {-7, 10, -6, 5, 218}, {-3, -9, -3, 9, 219}, {-1, -13, -1, 5, 220}, {-3, -7, -3, 4, 221}, {-8, -2, -8, 3, 222}, {4, 2, 12, 12, 223}, {2, -5, 3, 11, 224}, 
{6, -9, 11, -13, 225}, {3, -1, 7, 12, 226}, {11, -1, 12, 4, 227}, {-3, 0, -3, 6, 228}, {4, -11, 4, 12, 229}, {2, -4, 2, 1, 230}, {-10, -6, -8, 1, 231}, {-13, 7, -11, 1, 232}, 
{-13, 12, -11, -13, 233}, {6, 0, 11, -13, 234}, {0, -1, 1, 4, 235}, {-13, 3, -9, -2, 236}, {-9, 8, -6, -3, 237}, {-13, -6, -8, -2, 238}, {5, -9, 8, 10, 239}, {2, 7, 3, -9, 240}, 
{-1, -6, -1, -1, 241}, {9, 5, 11, -2, 242}, {11, -3, 12, -8, 243}, {3, 0, 3, 5, 244}, {-1, 4, 0, 10, 245}, {3, -6, 4, 5, 246}, {-13, 0, -10, 5, 247}, {5, 8, 12, 11, 248}, 
{8, 9, 9, -6, 249}, {7, -4, 8, -12, 250}, {-10, 4, -10, 9, 251}, {7, 3, 12, 4, 252}, {9, -7, 10, -2, 253}, {7, 0, 12, -2, 254}, {-1, -6, 0, -11, 255}};
